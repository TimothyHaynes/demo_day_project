var app = angular.module('myApp');
app.controller("jobListCtrl", function($http, $scope, inputFactory, diceFactory) {
   $scope.searchObject = inputFactory.returnObject();
   console.log($scope.searchObject);
  //  $http({
  //      method: 'GET',
  //      url: 'http://service.dice.com/api/rest/jobsearch/v1/simple.json?city=48207&direct=1&state=MI'
  //  }).then(function successCallback(response) {
  //          $scope.items = response.data.resultItemList;
  //          doTheMap();
  //      },
  //      function errorCallback(response) {
  //          console.log(response);
  //      });
  diceFactory.post($scope.searchObject, (response)=>{
    console.log(response);
    $scope.items = response.resultItemList;
    doTheMap();});
  // .then(()=>{$scope.diceData = diceFactory.data()});
  console.log($scope.diceData);
    $scope.globalMap;
    $scope.service;
    $scope.geocoder;

   function initMap(){
   $scope.globalMap = new google.maps.Map(document.getElementById('job-map'), {
       center: {
           lat: 42.2814,
           lng: -83.7483
       },
       scrollwheel: true,
       zoom: 10
       });
    }
    setTimeout(function () {
        initMap();
    }, 100);

    //The Dice API returns an array (currently)called $scope.items
    //First, I need to find the address and use it for the center
    //Also use the address for the center of the PlacesServices if provided
    //otherwise, use the zipcode for the center of PS
    //
    $scope.detailedMapsInfo = [];

    $scope.searchCenter = chooseCenterParam();
    $scope.latlng;
    function chooseCenterParam(){
        //only uses the stret address as the center if it was provided
        if ($scope.searchObject.street_address !== undefined){
            return $scope.searchObject.street_address + " " + $scope.searchObject.zipcode;
        }
        return $scope.searchObject.zipcode;
    }


    function getCenter() {
        //takes user input and centers the map on the selcted location
        chooseCenterParam();
        $scope.geocoder = new google.maps.Geocoder();
        $scope.geocoder.geocode({
            address: $scope.searchCenter,
            componentRestrictions: {
                country: 'US',
                postalCode: $scope.searchObject.zipcode
            }
        }, function(results, status) {
            if (status == 'OK') {
                $scope.latlng = results[0].geometry.location;
                $scope.globalMap.setCenter(results[0].geometry.location);
            }
        });
    }

    function addMarker(place){
        var marker = new google.maps.Marker({
            map: globalMap,
            position: place.geometry.location,
            icon: {
                url: 'http://maps.gstatic.com/mapfiles/circle.png',
                anchor: new google.maps.Point(10, 10),
                scaledSize: new google.maps.Size(10, 17)
            }
        });
    }

    $scope.locationsRequest = {
        query: location.company,
        location: $scope.latlng,
        radius: 4000,
    }; //passes information generated by the APIs from user's search parameters to getLocations function

    function getLocations() {
        $scope.service = new google.maps.places.PlacesService($scope.globalMap);
        //for each item returned by the DICE API...
        $scope.items.forEach(function(location){
            $scope.service.textSearch($scope.locationsRequest, function(results, status){
                if (status == google.maps.places.PlacesServiceStatus.OK) {
                    var thisId = google.maps.places.PlaceResult.place_id;
                    console.log("unique ID for " + this.company + " is: " + thisId);
                    console.log(results[0]);
                    $scope.service.getDetails({placeId: thisId}, function(place, status){
                        if (status == google.maps.places.PlacesServiceStatus.OK) {
                            $scope.detailedMapsInfo.push(place);
                            addMarker(results[0]);
                        }
                    });
                }
            });
        });
    }
    function doTheMap(){
        initMap();
        getCenter();
        getLocations();
    }

});

// app.controller('searchOutputCtrl', function($scope, inputFactory) {

// });
